<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購物車</title>

    <!-- vg style -->
    <%- include('share/head_link.ejs') %>
        <link rel="stylesheet" href="css/cart.css">


</head>

<body>
    <!-- 頁首 -->
    <%- include('share/header.ejs') %>
        <!-- 主要區塊 -->
        <main style="margin-top: 130px; margin-bottom: 50px;">
            <!-- progress bar -->
            <div>
                <ul id="progressbar">
                    <li class="active">購物車</li>
                    <li>結帳</li>
                    <li>送出訂單</li>
                    <li>訂購完成</li>
                </ul>
            </div>
            <div class="row mx-auto container">
                <section class="lside col col-md-7">
                    <!-- order items -->
                    <div id="orderitems">
                        <h3 class="vg-h3 text-center my-3">購物清單</h3>
                        <div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>品項</th>
                                        <th>規格</th>
                                        <th class="vg-href" onclick="cnotemodal()">備註<i
                                                class="mx-1 fa-solid fa-circle-info"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="cartitems">
                                    <!-- cart items here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!--  wish list -->
                    <div id="wishlist" class="mt-2">
                        <h5 class="vg-h5 mt-0">願望<br />清單</h5>
                        <div class="d-flex" id="wishlistitems">
                            <!-- wishlist items here -->
                        </div>
                    </div>
                    <!-- coupon -->
                    <div id="coupon" class="mt-2 mb-4">
                        <nav>
                            <div class="nav nav-tabs w-100" id="" role="tablist">
                                <button class="nav-link" id="nav-coupun-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-coupun" type="button" role="tab" aria-controls="nav-coupun"
                                    aria-selected="true">折扣碼</button>
                                <button class="nav-link active" id="nav-vgmoney-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-vgmoney" type="button" role="tab" aria-controls="nav-vgmoney"
                                    aria-selected="false">購物金</button>
                            </div>
                        </nav>
                        <div class="tab-content" id="">
                            <div class="tab-pane fade" id="nav-coupun" role="tabpanel" aria-labelledby="nav-coupun-tab"
                                tabindex="0">
                                <input type="text" class="form-control w-25 m-auto d-inline" name="" id="couponid"
                                    placeholder="請輸入折扣碼">
                                <button class="btn btn-vg-xs" value="">送出</button>
                                <p class="vg-ps text-warning mt-1">折扣碼錯誤</p>
                            </div>
                            <div class="tab-pane fade show active" id="nav-vgmoney" role="tabpanel"
                                aria-labelledby="nav-vgmoney-tab" tabindex="0">
                                <input type="text" class="form-control w-25 m-auto d-inline" name="" id="myyuseBonus"
                                    placeholder="請輸入欲折抵的購物金" oninput="bonusval(this)">
                                <button class="btn btn-vg-xs" value="" onclick="useBonus()">送出</button>
                                <p class="vg-ps mt-1">您擁有的購物金:
                                    <span class="text-primary" id="userBonus">0</span>&nbsp;&nbsp;&nbsp;
                                    <!-- <input type="radio" name="" id="useall"> <label for="useall">全部使用</label> -->
                                </p>
                            </div>
                        </div>

                    </div>
                </section>
                <section class="rside col col-md-4">
                    <!-- summary -->
                    <div id="summery">
                        <h3 class="vg-h3 text-center my-3">金額試算</h3>
                        <table id="" class="table">
                            <thead>
                                <tr>
                                    <th>品項</th>
                                    <th>金額</th>
                                </tr>
                            </thead>
                            <tbody id="summary_items">
                                <!-- order items here -->
                            </tbody>
                        </table>
                        <table id="summary_coupon" class="table w-50">
                            <tr>
                                <td class="vg-p vg-href" id="shippingfee" title="1~2人160元，3~4人290元"
                                    onclick="shippingfeeinfo()">運費<i class="mx-1 fa-solid fa-circle-info"></i>
                                    <div class="modal fade" id="shippingfeeinfo" data-bs-backdrop="static"
                                        data-bs-keyboard="false" tabindex="-1" aria-labelledby="shippingfeeLabel"
                                        aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-scrollable">
                                            <div class="modal-content">
                                                <div class="modal-header pt-4">
                                                    <h3 class="vg-h3 align-self-center">
                                                        運費
                                                    </h3>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div>
                                                        <p>各品項運費獨立計算</p>
                                                        <p>1~2人160元</p>
                                                        <p>3~4人290元</p>
                                                    </div>
                                                </div>
                                                <div class="modal-footer d-flex justify-content-center">
                                                    <button type="button" class="btn btn-vg-reg"
                                                        data-bs-dismiss="modal">關閉</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <!-- <td>320</td> -->
                            </tr>
                            <tr>
                                <td class="vg-p">折扣碼NPMSD</td>
                                <td id="coupondiscount">0</td>
                            </tr>
                            <tr>
                                <td class="vg-p">購物金</td>
                                <td id="bonusdiscount">0</td>
                            </tr>
                        </table>
                        <!-- <hr> -->
                        <div class="d-flex justify-content-around">
                            <div class="vg-h4">總金額</div>
                            <div class="vg-h3" id="total">0</div>
                        </div>
                    </div>
                    <!-- order -->
                    <div id="placeorder" class="text-center mt-5">
                        <a class="btn btn-vg-lg mt-2 mb-3 p-3" onclick="placeOrder()">結帳去</a><br />
                        <a href="/" class="vg-href">繼續購物</a>
                    </div>
                </section>
            </div>
        </main>
        <!-- 頁尾 -->
        <%- include('share/footer.ejs') %>

            <!-- vg JS -->
            <%- include('share/vg-main.ejs') %>
                <script src="js/cart.js"></script>
                <script>
                    $(function () {
                        var userData = localStorage.getItem('token');
                        var userToken = userData ? JSON.parse(userData) : false;
                        var uid = userToken.id;
                        // var userData = localStorage.getItem('token');
                        // // console.log(userData)
                        // if (userData !== null) {
                        //     var userToken = userData ? JSON.parse(userData) : false;
                        //     // 設定目前使用者id
                        //     var uid = userToken.id;
                        // } else {
                        //     Swal.fire({
                        //         title: '請先登入會員',
                        //         icon: 'warning',
                        //         showConfirmButton: false,
                        //         timer: 1500
                        //     }).then(
                        //         setTimeout(() => {
                        //             document.location.href = "/login/userlogin"
                        //         }, 2000)
                        //     )
                        // }

                        // 讀取購物車物件
                        $.get(`/cart/item/${uid}`, function (e) {
                            // console.log(e)
                            if (typeof (e) == 'string') {
                                items = JSON.parse(e);
                            } else {
                                items = e;
                            }
                            $("#cartitems").empty();
                            $.each(items, function (index, item) {
                                if (item.size == 's' && item.freq == '單次配送') {
                                    var trHtml = `
                            <tr class="${item.pid}">
                                <td class="${item.pid}">${item.pname}</span></td>
                                <td class="text-start">
                                    <div>
                                        <label for="quantity">份量
                                            <select name="size" id="quantity" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="s" selected>1-2</option>
                                                <option value="l">3-4</option>
                                            </select>
                                        </label>
                                        <label for="delivery">配送
                                            <select name="freq" id="delivery" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="單次配送" selected>單次配送</option>
                                                <option value="每周一次">每周一次</option>
                                                <option value="雙周一次">雙周一次</option> 
                                            </select>
                                        </label>
                                        <p class="vg-ps">內容：${item.pinfo} </p>
                                    </div>
                                </td>
                                <td class="${item.pid}">
                                    <input type="checkbox" value="家有兒童" id="kids" onclick="addtocnote(this)">
                                    <label for="kids">家有兒童</label><br />
                                    <input type="checkbox" value="辛香料" id="spice" onclick="addtocnote(this)">
                                    <label for="spice">辛香料</label><br />
                                    <button class="btn btn-vg-xs m-2 shadow-sm w-75 towishbtn" onClick="towishbtn(this)">下次再買</button>
                                </td>
                             </tr>         
                            `;
                                    $("#cartitems").append(trHtml);
                                } else if (item.size == 'l' && item.freq == '單次配送') {
                                    var trHtml = `
                            <tr class="${item.pid}">
                                <td class="${item.pid}">${item.pname}</td>
                                <td class="text-start">
                                    <div>
                                        <label for="quantity">份量
                                            <select name="size" id="quantity" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="s">1-2</option>
                                                <option value="l" selected>3-4</option>
                                            </select>
                                        </label>
                                        <label for="delivery">配送
                                            <select name="freq" id="delivery" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="單次配送" selected>單次配送</option>
                                                <option value="每周一次">每周一次</option>
                                                <option value="雙周一次">雙周一次</option> 
                                            </select>
                                        </label>
                                        <p class="vg-ps">內容：${item.pinfo} </p>
                                    </div>
                                </td>
                                <td class="${item.pid}">
                                    <input type="checkbox" value="家有兒童" id="kids2" onclick="addtocnote(this)">
                                    <label for="kids2">家有兒童</label><br />
                                    <input type="checkbox" value="辛香料" id="spice2" onclick="addtocnote(this)">
                                    <label for="spice2">辛香料</label><br />
                                    <button class="btn btn-vg-xs m-2 shadow-sm w-75 towishbtn" onClick="towishbtn(this)">下次再買</button>
                                </td>
                             </tr>         
                            `;
                                    $("#cartitems").append(trHtml);
                                } else if (item.size == 's' && item.freq == '每周一次') {
                                    var trHtml = `
                            <tr class="${item.pid}">
                                <td class="${item.pid}">${item.pname}</td>
                                <td class="text-start">
                                    <div>
                                        <label for="quantity">份量
                                            <select name="size" id="quantity" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="s" selected>1-2</option>
                                                <option value="l">3-4</option>
                                            </select>
                                        </label>
                                        <label for="delivery">配送
                                            <select name="freq" id="delivery" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="單次配送">單次配送</option>
                                                <option value="每周一次" selected>每周一次</option>
                                                <option value="雙周一次">雙周一次</option> 
                                            </select>
                                        </label>
                                        <p class="vg-ps">內容：${item.pinfo} </p>
                                    </div>
                                </td>
                                <td class="${item.pid}">
                                    <input type="checkbox" value="家有兒童" id="kids3" onclick="addtocnote(this)">
                                    <label for="kid3s">家有兒童</label><br />
                                    <input type="checkbox" value="辛香料" id="spice3" onclick="addtocnote(this)">
                                    <label for="spice3">辛香料</label><br />
                                    <button class="btn btn-vg-xs m-2 shadow-sm w-75 towishbtn" onClick="towishbtn(this)">下次再買</button>
                                </td>
                             </tr>         
                            `;
                                    $("#cartitems").append(trHtml);
                                } else if (item.size == 'l' && item.freq == '每周一次') {
                                    var trHtml = `
                            <tr class="${item.pid}">
                                <td class="${item.pid}">${item.pname}</td>
                                <td class="text-start">
                                    <div>
                                        <label for="quantity">份量
                                            <select name="size" id="quantity" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="s">1-2</option>
                                                <option value="l" selected>3-4</option>
                                            </select>
                                        </label>
                                        <label for="delivery">配送
                                            <select name="freq" id="delivery" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="單次配送">單次配送</option>
                                                <option value="每周一次" selected>每周一次</option>
                                                <option value="雙周一次">雙周一次</option> 
                                            </select>
                                        </label>
                                        <p class="vg-ps">內容：${item.pinfo} </p>
                                    </div>
                                </td>
                                <td class="${item.pid}">
                                    <input type="checkbox" value="家有兒童" id="kids4" onclick="addtocnote(this)">
                                    <label for="kids4">家有兒童</label><br />
                                    <input type="checkbox" value="辛香料" id="spice4" onclick="addtocnote(this)">
                                    <label for="spice4">辛香料</label><br />
                                    <button class="btn btn-vg-xs m-2 shadow-sm w-75 towishbtn" onClick="towishbtn(this)">下次再買</button>
                                </td>
                             </tr>         
                            `;
                                    $("#cartitems").append(trHtml);
                                } else if (item.size == 's' && item.freq == '雙周一次') {
                                    var trHtml = `
                            <tr class="${item.pid}">
                                <td class="${item.pid}">${item.pname}</td>
                                <td class="text-start">
                                    <div>
                                        <label for="quantity">份量
                                            <select name="size" id="quantity" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="s" selected>1-2</option>
                                                <option value="l">3-4</option>
                                            </select>
                                        </label>
                                        <label for="delivery">配送
                                            <select name="freq" id="delivery" class="form-select-sm ${item.pid}" onChange="handleitem(this)">
                                                <option value="單次配送">單次配送</option>
                                                <option value="每周一次">每周一次</option>
                                                <option value="雙周一次" selected>雙周一次</option> 
                                            </select>
                                        </label>
                                        <p class="vg-ps">內容：${item.pinfo} </p>
                                    </div>
                                </td>
                                <td class="${item.pid}">
                                    <input type="checkbox" value="家有兒童" id="kids5" onclick="addtocnote(this)">
                                    <label for="kids5">家有兒童</label><br />
                                    <input type="checkbox" value="辛香料" id="spice5" onclick="addtocnote(this)">
                                    <label for="spice5">辛香料</label><br />
                                    <button class="btn btn-vg-xs m-2 shadow-sm w-75 towishbtn" onClick="towishbtn(this)">下次再買</button>
                                </td>
                             </tr>         
                            `;
                                    $("#cartitems").append(trHtml);
                                } else {
                                    var trHtml = `
                            <tr class="${item.pid}">
                                <td class="${item.pid}">${item.pname}</td>
                                <td class="text-start">
                                    <div>
                                        <label for="quantity">份量
                                            <select name="size" id="quantity" class="form-select-sm ${item.pid}"  onChange="handleitem(this)">
                                                <option value="s">1-2</option>
                                                <option value="l" selected>3-4</option>
                                            </select>
                                        </label>
                                        <label for="delivery">配送
                                            <select name="freq" id="delivery" class="form-select-sm ${item.pid}"  onChange="handleitem(this)">
                                                <option value="單次配送">單次配送</option>
                                                <option value="每周一次">每周一次</option>
                                                <option value="雙周一次" selected>雙周一次</option> 
                                            </select>
                                        </label>
                                        <p class="vg-ps">內容：${item.pinfo} </p>
                                    </div>
                                </td>
                                <td class="${item.pid}">
                                    <input type="checkbox" value="家有兒童" id="kids6" onclick="addtocnote(this)">
                                    <label for="kids6">家有兒童</label><br />
                                    <input type="checkbox" value="辛香料" id="spice6" onclick="addtocnote(this)">
                                    <label for="spice6">辛香料</label><br />
                                    <button class="btn btn-vg-xs m-2 shadow-sm w-75 towishbtn" onClick="towishbtn(this)">下次再買</button>
                                </td>
                             </tr>         
                            `;
                                    $("#cartitems").append(trHtml);
                                }
                            })
                        }).then(function (res) {
                            console.log(res)
                            // 金額試算表格
                            var total = 0;
                            var shippingfee = 0;
                            res.map((item) => {
                                // 購買品項
                                item.size == 's' ? fee = 160 : fee = 290; // 運費 (S-160 L-290)
                                item.size == 's' ? item.size = '1~2人' : item.size = '3~4人';
                                item.c_note == null ? item.c_note = '無備註' : item.c_note
                                var divHtml = `
                            <tr>
                                <td>
                                    <p class="vg-p">${item.pname}</p>
                                    <p class="vg-ps">${item.size} ${item.freq} <span class="${item.pid}">${item.c_note}</span></p>
                                    
                                </td>
                                <td>${item.price}</td>
                            </tr>
                            `;
                                $('#summary_items').append(divHtml)
                                shippingfee += fee;
                                total += item.price;
                            })
                            // 運費計算
                            var tdHtml = `    
                        <td>${shippingfee}</td>
                        `;
                            $('#shippingfee').after(tdHtml)
                            // 總金額計算 (未含折扣碼與購物金)
                            $('#total').text(shippingfee + total)
                        })

                        // 讀取購物金
                        var bonus = 0;
                        $.get(`/user/bonus/${uid}`, function (e) {
                            // console.log(e[0].bonus)
                            bonus = e[0].bonus
                            $('#userBonus').text(bonus)
                        })

                        // 使用購物金
                        var usemyBonus = 0;
                        bonusval = (e) => {
                            // console.log(e.value)
                            // 若超過使用者擁有購物金，跳出提醒並以擁有購物金為最高值
                            if (e.value <= bonus) {
                                usemyBonus = -e.value;
                            } else {
                                Swal.fire({
                                    title: '超過折抵上限',
                                    icon: 'warning',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                myyuseBonus.value = bonus;
                                usemyBonus = -bonus;
                            }
                        }

                        useBonus = () => {
                            //  金額試算更新使用購物金
                            $('#bonusdiscount').text(usemyBonus);
                            // console.log( parseInt($('#total').text()) + usemyBonus )
                            var newTotal = parseInt($('#total').text()) + usemyBonus
                            $('#total').text(newTotal)
                        }


                        // 讀取願望清單物件
                        $.get(`/cart/wishlist/${uid}`, function (e) {
                            if (typeof (e) == 'string') {
                                items = JSON.parse(e);
                            } else {
                                items = e;
                            }
                            // $("#wishlistitems").empty();
                            $.each(items, function (index, item) {
                                var divHtml = `
                            <div class="myItem d-flex position-relative">
                                <img src="${item.pic}" alt="">
                                <div class="align-self-center text-center px-2" id=${item.pid}>
                                    <button class="btn btn-outline-dark btn-sm close-btn" onClick="deleteFromWishlist(this)">x</button>
                                    <p class="vg-p m-0 p-0 ">${item.pname}</p>
                                    <p class="vg-ps m-0 p-0">${item.price}</p>
                                    <button class="btn btn-vg-xs m-2 shadow-sm" onClick="buynow(this)">立刻買</button>
                                </div>
                            </div>         
                            `;
                                $("#wishlistitems").append(divHtml);
                            })
                        })

                        // 選擇份量和頻率 更新購物車 cart 資料表 (尚未完成)
                        handleitem = (e) => {
                            // 份量size || 頻率freq
                            console.log(e.name)
                            // value
                            var temp = e.options.selectedIndex
                            console.log(e.options[temp].value)
                            // pid
                            console.log(e.closest('tr[class*="aa"]').className)
                            // 產品名稱 ( 卡 )
                            console.log(e.closest('tr[class*="aa"]'))
                            // 判斷: 產品名稱+份量+頻率 => pid
                            // if( e.name == 'size' && e.options[temp].value == 's'){
                            //     e.closest('tr[class*="aa"]').className = ''
                            // }
                        }


                        // 將 c_note 推進 cart 資料表
                        var c_note = [];
                        addtocnote = (e) => {
                            // console.log(e.closest('td').className);
                            var pid = e.closest('td').className;
                            if (e.checked) {
                                if (!c_note[pid]) {
                                    c_note[pid] = [];
                                }
                                c_note[pid].push(e.value);
                            } else {
                                if (c_note[pid]) {
                                    const index = c_note[pid].indexOf(e.value);
                                    if (index !== -1) {
                                        c_note[pid].splice(index, 1);
                                        if (c_note[pid].length === 0) {
                                            // delete c_note[pid];
                                            c_note[pid].push('');
                                        }
                                    }
                                }
                            }
                            console.log(c_note);
                            Object.keys(c_note).map((pid) => {
                                var cnotestr = c_note[pid].join(' ');
                                // console.log(pid);
                                // console.log(cnotestr);
                                fetch('/editcart/c_note/', {
                                    method: 'PATCH',
                                    headers: {
                                        "Content-Type": "application/json ; charset=UTF-8"
                                    },
                                    body: JSON.stringify({
                                        c_note: cnotestr,
                                        pid: pid,
                                        uid: uid
                                    })
                                }).then(function () {
                                    // 若取消勾選所有備註項目，金額試算處同步調整內容
                                    if (cnotestr != '') {
                                        document.querySelector(`span[class=${pid}]`).innerText = cnotestr
                                    } else {
                                        document.querySelector(`span[class=${pid}]`).innerText = '無備註'
                                    }
                                })
                            });
                        }



                        // 點選下次再買按鈕 => 更新至wishlist資料表 => 刪除cart資料表中該項產品
                        towishbtn = (e) => {
                            // console.log(e.closest('tr[class*="aa"]').className)
                            var pid = e.closest('tr[class*="aa"]').className;
                            fetch('/addtowishlist/', {
                                method: 'post',
                                headers: {
                                    "Content-Type": "application/json ; charset=UTF-8"
                                },
                                body: JSON.stringify({
                                    uid: uid,
                                    pid: pid
                                })
                            }).then(
                                fetch('/cart/deleteitem/', {
                                    method: 'DELETE',
                                    headers: {
                                        "Content-Type": "application/json ; charset=UTF-8"
                                    },
                                    body: JSON.stringify({
                                        uid: uid,
                                        pid: pid
                                    })
                                })
                            ).then(
                                location.reload()
                            )
                        }

                        // 點選 立即買按鈕 => 更新至 cart 資料表 => 刪除wishlist資料表中該項產品
                        buynow = (e) => {
                            // console.log(e.closest('div[id^=aa]').id)
                            var pid = e.closest('div[id^=aa]').id;
                            fetch('/cart/additem/', {
                                method: 'post',
                                headers: {
                                    "Content-Type": "application/json ; charset=UTF-8"
                                },
                                body: JSON.stringify({
                                    uid: uid,
                                    pid: pid
                                })
                            }).then(
                                fetch('/delwishlist/', {
                                    method: 'DELETE',
                                    headers: {
                                        "Content-Type": "application/json ; charset=UTF-8"
                                    },
                                    body: JSON.stringify({
                                        uid: uid,
                                        pid: pid
                                    })
                                })
                            ).then(
                                location.reload()
                            )
                        }

                        // 從願望清單刪除
                        deleteFromWishlist = (e) => {
                            var pid = e.closest('div[id^=aa]').id;
                            Swal.fire({
                                title: '確定要移除本產品?',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: '確定',
                                cancelButtonText: '取消'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    fetch('/delwishlist/', {
                                        method: 'DELETE',
                                        headers: {
                                            "Content-Type": "application/json ; charset=UTF-8"
                                        },
                                        body: JSON.stringify({
                                            uid: uid,
                                            pid: pid
                                        })
                                    }).then(
                                        function (response) {
                                            if (response.status === 200) {
                                                e.closest('.myItem').remove();
                                                // location.reload()
                                            }
                                        });
                                }
                            })
                        }




                        // 按下結帳去的動作
                        placeOrder = () => {
                            // 亂數產生一個 oid 並推進 cart 資料表 ( c_status = active的項目 )
                            // console.log( $('#total').text() )
                            if ($('#total').text() <= 0) {
                                Swal.fire({
                                    title: '您還沒有進行購物，請先到產品區逛逛喔！',
                                    icon: 'warning',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(
                                    setTimeout(() => {
                                        document.location.href = "/"
                                    }, 2000)
                                )
                            } else {
                                var oid = parseInt((Math.random()) * 10000000)
                                console.log(oid)
                                // 每個item 的 c_status 由 active 轉為 inactive
                                fetch('/editcart/status/', {
                                    method: 'PATCH',
                                    headers: {
                                        "Content-Type": "application/json ; charset=UTF-8"
                                    },
                                    body: JSON.stringify({
                                        oid: oid,
                                        uid: uid
                                    })
                                }).then(
                                    // 建立訂單 oid || uid 
                                    fetch('/editcart/createorder/', {
                                        method: 'post',
                                        headers: {
                                            "Content-Type": "application/json ; charset=UTF-8"
                                        },
                                        body: JSON.stringify({
                                            oid: oid,
                                            uid: uid
                                        })
                                    })
                                ).then(
                                    document.location.href = "/order/"
                                )
                            }
                        }



                    })
                </script>


</body>

</html>